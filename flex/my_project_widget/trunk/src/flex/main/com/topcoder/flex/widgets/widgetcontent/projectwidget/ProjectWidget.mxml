<?xml version="1.0" encoding="utf-8"?>
<tc:ProjectWidgetCodeBehind xmlns:mx="http://www.adobe.com/2006/mxml"
    xmlns:tc="com.topcoder.flex.widgets.widgetcontent.projectwidget.*"
    xmlns:ns1="com.topcoder.flex.widgets.widgetcontent.projectwidget.com.*" headerHeight="5" 
    width="100%" height="100%"
    creationComplete="initWidget()" layout="absolute" horizontalScrollPolicy="off" verticalScrollPolicy="off">
    <mx:Style source="Style.css" />
    
<mx:Script>
    <![CDATA[
    	import com.topcoder.flex.widgets.widgetcontent.projectwidget.qs.Contest;
    	import mx.rpc.events.ResultEvent;
        import mx.collections.ArrayCollection;
        import mx.core.IUIComponent;
        import mx.core.UIComponent;
        import mx.controls.Button;
        import mx.controls.Alert;
        import mx.core.DragSource;
        import flash.events.MouseEvent;
        import mx.containers.Canvas;
        import mx.events.DragEvent;
        import mx.events.CloseEvent;
        import mx.rpc.soap.SOAPHeader;
        
        import com.topcoder.flex.widgets.widgetcontent.projectwidget.com.ProjectList;
		import com.topcoder.flex.widgets.widgetcontent.projectwidget.qs.Project;
        /**
         * Handle cursor's image class.
         */
        [Embed(source="../assets/image/cursor.gif")]
            private var cursor:Class;
        [Embed(source="../assets/image/arrow_left.gif")]
            private var leftArrow:Class;
        [Embed(source="../assets/image/arrow_right.gif")]
            private var rightArrow:Class;

        private var closeBtn : Button = new Button();
        private var maxrestoreBtn : Button = new Button();
        private var refreshBtn : Button = new Button();
        private var collapseBtn : Button = new Button();
        private var helpBtn : Button = new Button();
        private var isMax : Boolean = false;
        private var originalHeight:Number;
        private var myprjData:ArrayCollection;

        private var windowState:Number=WINDOW_STATE_DEFAULT;

        public static const WINDOW_STATE_DEFAULT:Number = -1;
        public static const WINDOW_STATE_COLLAPSED:Number = 0;
        public static const WINDOW_STATE_MAXIMIZED:Number = 1;
        public static const COLLAPSED_HEIGHT:Number = 50;
        public static const LEFTSPACE:Number=25;

        private var iconSize:int=18;
        private var iconGap:int=10;

        private var loader:URLLoader = new URLLoader();

        public function get maximized():Boolean
        {
            return isMax;
        }

        /**
         * Current selected column index.
         */
        [Bindable]
        public var columnIndx: int;

        /**
         * Current selected row index.
         */
        [Bindable]
        public var rowIndx: int;
        [Bindable]
        private var projectId:int;
        
        private var pname:String;
        private var pdesc:String;
        
        private var contests:ArrayCollection;
        
        private var prjArray:ArrayCollection;
        
        private var prjIdx:int=0;
        
        private static const WSSE_SECURITY:QName = new QName( "http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd", "Security" );
		
		
		public static function getHeader(username:String, password:String):SOAPHeader
		{
			var userToken:String = "UsernameToken-"+Math.round(Math.random()*999999).toString();
			var headerXML : XML =  <wsse:Security xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd">
         			<wsse:UsernameToken wsu:Id={userToken} xmlns:wsu='http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd'>
	            		<wsse:Username>{username}</wsse:Username>
	            		<wsse:Password Type="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordDigest">{password}</wsse:Password>
         			</wsse:UsernameToken>
      			</wsse:Security>;
      		var header : SOAPHeader = new SOAPHeader( WSSE_SECURITY, headerXML );
      		return header;
		}



        private function initWidget():void{
        	//flash.system.Security.loadPolicyFile("http://localhost:8003/widget_app/crossdomain.xml");
            loader.addEventListener(Event.COMPLETE, loadData);
            loader.load(new URLRequest("data/moch.xml"));
			
            
        }
        // this function load an XML as data provider of the main container
        // of the projectList
        private function loadXML(e:Event):void
        {
            result = new XML(e.target.data);
            prjList.dataProvider=result;
        }
        private function loadData(e:Event):void
        {
            var header:SOAPHeader=getHeader("user","password");
			ProjectServiceFacadeBean.clearHeaders();
            ProjectServiceFacadeBean.addHeader(header);

            ProjectServiceFacadeBean.getAllProjects();
            
        }
        private function setProject(e:ResultEvent): void
        {
        	if(e!=null && e.result!=null){
        		prjArray=e.result as ArrayCollection;
        		prjIdx=0;
        		if(prjIdx<prjArray.length)
        		{
        			pname=prjArray[prjIdx].name;
        			pdesc=prjArray[prjIdx].description;
        			projectId=prjArray[prjIdx].projectId;
        			prjIdx++;
        			ContestServiceFacadeBean.clearHeaders();
        			ContestServiceFacadeBean.addHeader(getHeader("user","password"));
        			ContestServiceFacadeBean.getContestsForProject.send();
        		}
        	}
        }
        private function setContests(e:ResultEvent): void
        {
        	contests=new ArrayCollection();
        	if(e!=null && e.result!=null)
        	{
        		var arr:ArrayCollection=e.result as ArrayCollection;
        		for(var i:int=0;i<arr.length;i++)
        		{
        			var c:Contest=new Contest(arr[i].contestData.contestId,arr[i].contestData.name,arr[i].startTime,
        			arr[i].endTime,arr[i].contestData.numberOfRegistrants,           arr[i].contestData.submissionCount,
        			arr[i].contestData.forumPostCount,arr[i].contestData.forumId,arr[i].contestData.statusId);
        			contests.addItem(c);
        		}
        	}
        	
        	var list:ProjectList=new ProjectList();
			prjList.addChild(list);
			list.setStyle("verticalScrollPolicy","off");
			list.dataProvider=new Project(pname,pdesc,"",contests);
			
				if(prjIdx<prjArray.length)
        		{
        			pname=prjArray[prjIdx].name;
        			pdesc=prjArray[prjIdx].description;
        			projectId=prjArray[prjIdx].projectId;
        			prjIdx++;
        			ContestServiceFacadeBean.clearHeaders();
        			ContestServiceFacadeBean.addHeader(getHeader("user","password"));
        			ContestServiceFacadeBean.getContestsForProject.send();
        		}
        	
        	
        }
    ]]>
</mx:Script>
<mx:WebService id="ProjectServiceFacadeBean" 
wsdl="http://67.202.36.242:8003/services-project_service_facade/ProjectServiceFacadeBean?wsdl"> 
<mx:operation name="getAllProjects" resultFormat="object" result="setProject(event)"  /> 
</mx:WebService>
<mx:WebService id="ContestServiceFacadeBean" 
wsdl="http://174.129.135.92:8003/topcoder_contest_service_facade-topcoder_contest_service_facade/ContestServiceFacadeBean?wsdl"> 
<mx:operation name="getContestsForProject" resultFormat="object" result="setContests(event)"> 
<mx:request>
<arg0>{projectId}</arg0>
</mx:request>
</mx:operation>
</mx:WebService>
    <mx:Canvas top="5" right="15" left="10" horizontalScrollPolicy="off" verticalScrollPolicy="auto" bottom="5">
        <ns1:ProjectsContainer id="prjList"  horizontalScrollPolicy="off" verticalScrollPolicy="off" maxHeight="500"  width="100%" height="100%">
        </ns1:ProjectsContainer>
    </mx:Canvas>
</tc:ProjectWidgetCodeBehind>