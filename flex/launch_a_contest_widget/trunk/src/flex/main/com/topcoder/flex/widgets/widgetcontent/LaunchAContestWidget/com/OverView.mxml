<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%"
          horizontalScrollPolicy="off" verticalScrollPolicy="off">
          
          <mx:HTTPService id="requestContestTypes" url="data/launch_a_contest/contestTypes.xml" resultFormat="xml" result="preprocessTypes(event)" ></mx:HTTPService>
    <mx:Script>
    <![CDATA[
    	import mx.collections.ArrayCollection;
    	import mx.controls.RadioButton;
    	import mx.rpc.events.ResultEvent;
    	import com.topcoder.flex.widgets.widgetcontent.LaunchAContestWidget.webservice.generated.PrizeData;
    	import com.topcoder.flex.widgets.widgetcontent.LaunchAContestWidget.LaunchWidget;
    	import mx.containers.Panel;
    	import mx.events.FlexEvent;
    	import mx.controls.Alert;
        import mx.events.ItemClickEvent;
        
        private static var inputs:Array = ["firstPlace","secondPlace","thirdPlace","fourthPlace","fifthPlace"]; 
        private static var inputsMap:Object = {1:"firstPlace", 2:"secondPlace", 3:"thirdPlace", 4:"fourthPlace", 5:"fifthPlace"};
        
        [Bindable]
       	public var mainWidget:LaunchWidget;
       	
        public function initData():void{
        	requestContestTypes.send();
        	
        	var inputsMap:Object = {1:firstPlace, 2:secondPlace, 3:thirdPlace, 4:fourthPlace, 5:fifthPlace};
        	
        	for each (var prize:PrizeData in mainWidget.competition.contestData.prizes){
        		var p:int = prize.place as int;
        		var input:TextInput = inputsMap[p] as TextInput;
        		input.text = prize.amount.toString();
        	}
        	
        	updateAmount();
        }
        
        private function updateResult():Boolean{
        	
        	mainWidget.competition.contestData.contestTypeId = Number(studioType.selectedValue);
        	
        	var prizes:Array = new Array();
        	mainWidget.competition.contestData.prizes = prizes;
        	for (var i:int=0; i<inputs.length; i++){
        		var prizeData:PrizeData = new PrizeData();
        		
        		var input:TextInput = this[inputs[i]] as TextInput;
        		var amount:Number = Number(input.text);
        		if (amount<=0){
        			break;
        		}
        		
        		prizeData.place = i+1;
        		prizeData.amount = amount;
        		prizes.push(prizeData);
        	}
        	
        	mainWidget.competition.prizes = prizes;
        	
        	return true;
        }
        
        
        private function handleSelect(event:ItemClickEvent):void {
        	typeName.text = (event.currentTarget as RadioButtonGroup).selection.label;
        }
        
        
        
        private function updateAmount():void{
        	var sum:int = 0;
        	for each (var name:String in inputs){
        		
        		var input:TextInput = this[name] as TextInput;
        		var val:int = Number(input.text);
        		
        		if (isNaN(val)){
        			input.text = "";
        		}
        		
        		sum = sum + val;
        	}
        	
        	if (sum>0){
        		adminf.text = new Number(sum * 0.2).toFixed(0);
        		cntstTtl.text = new Number(sum * 1.2).toFixed(0);
        	} else {
        		adminf.text = "";
        		cntstTtl.text = "";
        	}
        }
        
        public function validateFields():Boolean{
        	if (studioType.selection == null){
        		Alert.show("Contest type not selected");
        		return false;
        	}
        	
        	for (var i:int=0; i<inputs.length -1; i++){
        		
        		var input:TextInput = this[inputs[i]] as TextInput;
        		var val:int = Number(input.text);
        		
        		var nextInput:TextInput = this[inputs[i+1]] as TextInput;
        		
        		if (isNaN(Number(input.text)) || (Number(input.text) == 0 && Number(nextInput.text)>0)){
        			Alert.show("Prize amount not set");
        			input.setFocus();
        			return false;
        		}
        		
        		if (Number(input.text) > 0 && Number(nextInput.text) >= Number(input.text)){
        			Alert.show("Prize "+ (i+1)+ " is incorrect");
        			nextInput.setFocus();
        			return false;
        		}
        		
        		if (Number(cntstTtl.text) == 0){
        			Alert.show("No prize set");
        			return false;
        		}
        	}
        	
        	updateResult();
        	
        	return true;
        }
        
        private function preprocessTypes(e:ResultEvent): void
        {
        	var contestType:String = mainWidget.competition.contestData.contestTypeId.toString();
        	
        	if(e!=null && e.result!=null && e.result is XMLNode)
        	{
        		var root:XMLNode=e.result as XMLNode;
        		for(var i:int=0;i<root.childNodes.length;i++)
        		{
        			if(studioTypeBox.getChildren().length==0)
        			{
        				studioTypeBox.addChild(new VBox());
        			}
        			var vbox:VBox=studioTypeBox.getChildAt(studioTypeBox.getChildren().length-1) as  VBox;
        			if(vbox.getChildren().length>=3)
        			{
        				studioTypeBox.addChild(new VBox());
        				vbox=studioTypeBox.getChildAt(studioTypeBox.getChildren().length-1) as  VBox;
        			}
        			var typeRadio:RadioButton=new RadioButton();
        			typeRadio.group = studioType;
        			typeRadio.label=root.childNodes[i].attributes.description;
        			typeRadio.value=root.childNodes[i].attributes.contestTypeId;
        			
        			if (typeRadio.value == contestType){
        				typeRadio.selected = true;
        			}
        			vbox.addChild(typeRadio);
        		}
        	}
        	else if(e!=null && e.result!=null && e.result is ArrayCollection){
        		var types:ArrayCollection=e.result as ArrayCollection;
        		for(var i:int =0; i<types.length;i++)
        		{
        			if(studioTypeBox.getChildren().length==0)
        			{
        				studioTypeBox.addChild(new VBox());
        			}
        			var vbox:VBox=studioTypeBox.getChildAt(studioTypeBox.getChildren().length-1) as  VBox;
        			if(vbox.getChildren().length>=3)
        			{
        				studioTypeBox.addChild(new VBox());
        				vbox=studioTypeBox.getChildAt(studioTypeBox.getChildren().length-1) as  VBox;
        			}
        			var typeRadio:RadioButton=new RadioButton();
        			typeRadio.group = studioType;
        			typeRadio.label=types[i].description;
        			typeRadio.value=types[i].contestTypeId;
        			vbox.addChild(typeRadio);
        			if (typeRadio.value == contestType){
        				typeRadio.selected = true;
        			}
        		}
        		
        		
        	}
        }
    ]]>
    </mx:Script>
    <mx:VBox>
        <mx:Label text="Contest Overview" fontWeight="bold" fontSize="12"/>
        <mx:Label text="What Type of Contest do you want to run?" fontWeight="bold"/>
                <mx:RadioButtonGroup id="studioType" itemClick="handleSelect(event);"/>
        <mx:HBox id="studioTypeBox" horizontalGap="0">
        </mx:HBox>
        <mx:HRule width="100%" strokeColor="0x000000"/>
         
        <mx:Label id="typeName" text="Application Front End Design" fontWeight="bold" fontSize="12"/>
        <mx:Text width="100%" id="description" >
            <mx:text>
                <![CDATA[Widget & application UI designs, storyboards and mock-ups. Widget & application UI designs, storyboards and mock-ups. Widget & application UI designs, storyboards and mock-ups.]]>
            </mx:text>
        </mx:Text>
        <mx:Spacer height="10"/>
        <mx:HBox verticalAlign="top" horizontalGap="0">
            <mx:Label text="Exmaples:" fontWeight="bold" paddingTop="0"/>
            <mx:VBox verticalAlign="top" verticalGap="0">
                <mx:Spacer height="5"/>
                <mx:Image source="@Embed('../../assets/PreviewImage.png')"/>        
            </mx:VBox>
            <mx:VBox verticalGap="0">
            	<mx:Label text="Application Design Contest Title" fontWeight="bold"/>
            	<mx:Label text="Prizes: $750, $500, $250"/>
            	<mx:Label text="Duration: 6 days"/>
            	<mx:Label text="Registrants: 20"/>
            	<mx:Label text="Submission: 15"/>
            </mx:VBox>
            <mx:VBox verticalAlign="top" verticalGap="0">
                <mx:Spacer height="5"/>
                <mx:Image source="@Embed('../../assets/PreviewImage.png')"/>
            </mx:VBox>
            <mx:VBox verticalGap="0">
                <mx:Label text="Application Design Contest Title" fontWeight="bold"/>
                <mx:Label text="Prizes: $750, $500, $250"/>
                <mx:Label text="Duration: 6 days"/>
                <mx:Label text="Registrants: 20"/>
                <mx:Label text="Submission: 15"/>
            </mx:VBox>
        </mx:HBox>
        <mx:Spacer height="5"/>
        <mx:VBox width="100%" verticalGap="0">
	        <mx:Label text="Suggested 1st Place Prize Amounts:" fontWeight="bold"/>
	        <mx:Label text="- Minimum: $200"/>
	        <mx:Label text="- Average: $400-700"/>
	        <mx:Label text="- High Exposure: $800 and up"/>
        </mx:VBox>
        
        <mx:Spacer height="5"/>
        <mx:VBox width="100%" verticalGap="0">
        <mx:Label text="Your Prize Amounts:" fontWeight="bold"/>
	        <mx:Text width="100%" paddingTop="0">
	            <mx:text>
	                When entering prizes, please note that each prize amount must be the same or lower than 
	                the amount in the places above it.
	            </mx:text>
	        </mx:Text>
        </mx:VBox>
        <mx:Spacer height="10"/>
        <mx:HBox verticalAlign="top" >
            <mx:VBox>
            	<mx:HBox>
            	   <mx:Label text="1st Place: $" fontWeight="bold"/>
            	   <mx:TextInput id="firstPlace" width="120" text="" change="updateAmount()"/>
            	</mx:HBox>
                <mx:HBox>
                   <mx:Label text="2nd Place: $" fontWeight="bold"/>
                   <mx:TextInput id="secondPlace" width="120" text="" change="updateAmount()"/>
                </mx:HBox>
                <mx:HBox>
                   <mx:Label text="3rd Place: $" fontWeight="bold"/>
                   <mx:TextInput id="thirdPlace" width="120" text="" change="updateAmount()"/>
                </mx:HBox>
            </mx:VBox>
            
            <mx:VBox >
                <mx:HBox>
                   <mx:Label text="4th Place: $" fontWeight="bold"/>
                   <mx:TextInput id="fourthPlace" width="120" text="" change="updateAmount()"/>
                </mx:HBox>
                <mx:HBox>
                   <mx:Label text="5th Place: $" fontWeight="bold"/>
                   <mx:TextInput id="fifthPlace" width="120" text="" change="updateAmount()"/>
                </mx:HBox>
            </mx:VBox>
            
            <mx:VBox >
                <mx:HBox>
                   <mx:Label text="20% Admin Fee: $" fontWeight="bold"/>
                   <mx:TextInput id="adminf" text="" width="55"  editable="false"/>
                </mx:HBox>
                <mx:HBox>
                   <mx:Label text="Contest Total: $" fontWeight="bold"/>
                   <mx:Spacer width="7"/>
                   <mx:TextInput id="cntstTtl" text="" width="55" editable="false"/>
                </mx:HBox>
            </mx:VBox>
        </mx:HBox>
     </mx:VBox>   
</mx:Canvas>
