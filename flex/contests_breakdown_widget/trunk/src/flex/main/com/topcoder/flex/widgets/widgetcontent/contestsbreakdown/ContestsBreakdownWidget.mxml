<?xml version="1.0" encoding="utf-8"?>

<tc:ContestsBreakdownWidgetCodeBehind xmlns:mx="http://www.adobe.com/2006/mxml"
    xmlns:tc="com.topcoder.flex.widgets.widgetcontent.contestsbreakdown.*"
    creationComplete="jsonRequest.send()" 
	height="100%" width="100%" resizeEffect="{resize}">

	<mx:HTTPService id="jsonRequest" url="http://www.topcoder.com/tc?" resultFormat="text"
	    result="handleJsonResult(event)" >
		<mx:request>
			<module>BasicData</module>
			<c>dd_active_contest_info</c>
			<dsid>28</dsid>
			<drt>json</drt>
		</mx:request> 
	</mx:HTTPService>    
	
	<mx:Script>
	    <![CDATA[
	        import mx.utils.StringUtil;
	        import mx.formatters.CurrencyFormatter;
	        import mx.charts.series.PieSeries;
	        import com.adobe.serialization.json.JSON;
	        import mx.rpc.events.ResultEvent;
	        import mx.collections.ArrayCollection;
	
	        // Currency formatter for the total prizes data
	        private var currencyFormatter:CurrencyFormatter = new CurrencyFormatter();
	
	        private function init():void {
	            currencyFormatter.precision = 2;
	        }
	
	        // Label function for the total contests data
	        private function displayTotalContests(data:Object, field:String, index:Number, percentValue:Number):String {
	            return data.category_name + ": " + data.total_contests;
	        }
	
	        // Label function for the prize data
	        private function displayPrizes(data:Object, field:String, index:Number, percentValue:Number):String {
	            return data.category_name + ": " + currencyFormatter.format(data.total_prizes);
	        }
	
	        // Handles the result from the HTTPService
	        private function handleJsonResult(event:ResultEvent):void {
	            var json:String = event.result as String;
	
	            var jsonData:Object = JSON.decode(json);
	
	            // Get the data for the pie charts
	            var arrayData:Array = jsonData.data as Array;
	            chartData = new ArrayCollection(arrayData);
	        }
	    ]]>
	</mx:Script>
        <mx:HBox width="100%" height="199">
                <mx:PieChart id="chart1" dataProvider="{chartData}" showDataTips="true" width="100%" height="100%">
                    <mx:series>
                        <mx:PieSeries field="total_contests" nameField="category_name"
                            labelFunction="displayTotalContests" labelPosition="outside" />
                    </mx:series>
                </mx:PieChart>
                <mx:PieChart id="chart2" dataProvider="{chartData}" showDataTips="true" width="100%" height="100%">
                    <mx:series>
                        <mx:PieSeries field="total_prizes" nameField="category_name"
                            labelFunction="displayPrizes" labelPosition="outside">
                        </mx:PieSeries>
                    </mx:series>
                </mx:PieChart>
        </mx:HBox>

  <mx:Resize id="resize" /> 
</tc:ContestsBreakdownWidgetCodeBehind>
