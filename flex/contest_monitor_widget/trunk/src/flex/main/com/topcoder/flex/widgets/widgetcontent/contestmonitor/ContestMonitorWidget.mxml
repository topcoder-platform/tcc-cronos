<?xml version="1.0" encoding="utf-8"?>
<tc:ContestMonitorWidgetCodeBehind xmlns:mx="http://www.adobe.com/2006/mxml"
    xmlns:tc="com.topcoder.flex.widgets.widgetcontent.contestmonitor.*"
    horizontalAlign="left"
    width="100%" height="100%"
    creationComplete="fetchData()">

<mx:Script>
    <![CDATA[
        import flash.net.URLLoader;
        import flash.net.URLRequest;
        import flash.events.Event;
        import mx.controls.Alert;
        import flash.utils.Timer;
        import flash.events.TimerEvent;
        import mx.events.SliderEvent;        
        import mx.collections.ArrayCollection;        
    	import mx.rpc.events.ResultEvent;
    	
        import mx.rpc.soap.SOAPHeader;

        private var startTime:Date;
        private var endTime:Date;
        private static const daySeconds:Number = 24*60*60;
        private static const halfDaySeconds:Number = 12*60*60;
        private static const hourSeconds:Number = 60*60;

	public static var SLIDER_TICK_LENGTH:Number = 0;
	public static var TRACK_WIDTH:Number = 393;
        
        
        private static const WSSE_SECURITY:QName = new QName( "http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd", "Security" );
		
		
		public static function getHeader(username:String, password:String):SOAPHeader
		{
			var userToken:String = "UsernameToken-"+Math.round(Math.random()*999999).toString();
			var headerXML : XML =  <wsse:Security xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd">
         			<wsse:UsernameToken wsu:Id={userToken} xmlns:wsu='http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd'>
	            		<wsse:Username>{username}</wsse:Username>
	            		<wsse:Password Type="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordDigest">{password}</wsse:Password>
         			</wsse:UsernameToken>
      			</wsse:Security>;
      		var header : SOAPHeader = new SOAPHeader( WSSE_SECURITY, headerXML );
      		return header;
		}
        
        // *** THIS NEEDS TO BE REPLACED WITH CALLS TO A SERVICE ***
        //fetch data from local xml file
        private function fetchData():void {
            var url:URLRequest = new URLRequest("data/timeline.xml");
            var loader:URLLoader = new URLLoader();
            loader.addEventListener(Event.COMPLETE, getData);
            loader.load(url);
        }
        
        //after loading the xml file, fetch data
        private function getData(event:Event):void {
        	var header:SOAPHeader=getHeader("user","password");
			ContestServiceFacadeBean.clearHeaders();
            ContestServiceFacadeBean.addHeader(header);

            ContestServiceFacadeBean.getContest.send();
        	
        }
        
        
        //display remaining time
        private function displayRemainTime():void{
            var currentTime:Date = new Date();
            var remainTime:Number = endTime.getTime() - currentTime.getTime();
            if (remainTime < 0){
                timeRem.text = "0 days, 0 hours";
                //stop text effect
                if (textEffect.isPlaying)
                   textEffect.end();
                return;
            }
            var remainDay:String = int(remainTime/(daySeconds*1000)).toString();
            var remainHour:String = int((remainTime - Number(remainDay)*daySeconds*1000)/(hourSeconds*1000)).toString();
            var timeRemain:String = remainDay + " days, " + remainHour + " hours";
            timeRem.text = timeRemain;
            //add effect
            if (Number(remainDay) == 0 && Number(remainHour) <= 12)
            {
                if (!textEffect.isPlaying)
                    textEffect.play();
            }
        }
        
        //timer handler executed every second
        private function timerHandler(event:TimerEvent):void {
            var currentTime:Date = new Date();
            var currentPos:Number = (currentTime.getTime() - startTime.getTime())/1000;
            timeLine.setThumbValueAt(0, currentPos);
            displayRemainTime();
            if(endTime.getTime() - currentTime.getTime() <= 0)
                event.target.stop();
        }
        
        private function setContest(e:ResultEvent): void
        {
        	if(e==null || e.result==null)return;
        	
        	regs.text = e.result.contestData.numberOfRegistrants;
            subms.text = e.result.contestData.submissionCount;
        	start.text = e.result.startTime[0];
            end.text = e.result.endTime[0];
            /*
            var datePattern:RegExp = /-/g;
            var endTimeTmp:String = e.result.endTime[0];
            var timeZoneIndex:Number = endTimeTmp.indexOf("GMT");
            var endTimeTmp1:String = endTimeTmp.substring(0, timeZoneIndex).replace(datePattern, "/");
            var endTimeTmp2:String = endTimeTmp.substring(timeZoneIndex, endTimeTmp.length);
            */
            var datePattern:RegExp = /-/g;
            var datePattern2:RegExp = /T/g;
            var endTimeTmp:String = e.result.endTime[0];
           var timeZoneIndex:Number = endTimeTmp.lastIndexOf("-");
            endTimeTmp = endTimeTmp.substring(0, timeZoneIndex);
            timeZoneIndex = endTimeTmp.indexOf("T");
            var endTimeTmp1:String = endTimeTmp.substring(0, timeZoneIndex).replace(datePattern, "/");
            var endTimeTmp2:String = endTimeTmp.substring(timeZoneIndex+1, endTimeTmp.length).substring(0,8);  
            endTime=new Date(endTimeTmp1 +" "+ endTimeTmp2); //new Date(endTimeTmp1 + endTimeTmp2);
            
            var startTimeTmp:String = e.result.startTime[0];
            timeZoneIndex = startTimeTmp.lastIndexOf("-");
            startTimeTmp=startTimeTmp.substring(0, timeZoneIndex);
            timeZoneIndex = startTimeTmp.indexOf("T");
            var startTimeTmp1:String = startTimeTmp.substring(0, timeZoneIndex).replace(datePattern, "/");
            var startTimeTmp2:String = startTimeTmp.substring(timeZoneIndex+1, startTimeTmp.length).substring(0,8);;
        	startTime=new Date(startTimeTmp1 + " "+startTimeTmp2);
            var currentTime:Date = new Date();
            var timeSpan:Number = (endTime.getTime() - startTime.getTime())/1000;
            timeLine.maximum = timeSpan;
            var currentPos:Number = (currentTime.getTime() - startTime.getTime())/1000;
            timeLine.value = currentPos;
            
            var tickValuesArry:Array = new Array();
            var labelsArry:Array = new Array();
            var totalHalfDays:int = int(timeSpan/halfDaySeconds);
            var totalDays:int = int(timeSpan/daySeconds);
            if (totalDays == 0){
                tickValuesArry.push(0);
                tickValuesArry.push(timeSpan);
                timeLine.tickValues = tickValuesArry;
                timeLine.labels = ["START", "END"]; 
            }else{
                var i:int = 0;
                if (timeSpan == totalHalfDays*halfDaySeconds){
                   for (i = 0; i <= totalDays; i++){
                        tickValuesArry.push(i*daySeconds);
                        if(i == 0)
                            labelsArry.push("START");
                        else if(i == totalDays)
                            labelsArry.push("END");
                        else{      
                            labelsArry.push("DAY "+i.toString());
                        }
                   }
                }else{
                    for (i = 0; i <= totalDays; i++){
                        tickValuesArry.push(i*daySeconds);
                        if(i == 0)
                            labelsArry.push("START");
                        else{
                            labelsArry.push("DAY "+i.toString());
                            labelsArry.push("");
                        }
                    }
                    tickValuesArry.push(timeSpan);
                    labelsArry.push("END");                            
                }
                timeLine.tickValues = tickValuesArry;
                timeLine.labels = labelsArry;
                
            }
            
            displayRemainTime();
            
           // var slider:HSlider = event.target as HSlider;
            timeLine.getThumbAt(0).enabled = false;
            
            //update time line every minute
            var timeLineTimer:Timer = new Timer(60*1000, 0);
            timeLineTimer.addEventListener("timer", timerHandler);
            timeLineTimer.start();
        }
    ]]>
</mx:Script>
<mx:WebService id="ContestServiceFacadeBean" 
wsdl="http://174.129.135.92:8003/topcoder_contest_service_facade-topcoder_contest_service_facade/ContestServiceFacadeBean?wsdl"> 
<mx:operation name="getContest" resultFormat="object" result="setContest(event)"> 
<mx:request><arg0>{contestid}</arg0></mx:request>
</mx:operation>
</mx:WebService>
 
			<mx:Spacer height="10"/>
			<mx:Box styleName="infoBox" height="70" width="100%" verticalGap="0">
				<mx:Spacer height="13"/>
				<mx:HBox width="224">
			       <mx:Label text="Registrants :" styleName="infoBoxTxt" width="140"/>
			       <mx:Text id="regs" styleName="infoBoxTxt" />
			    </mx:HBox>
			    <mx:HBox width="224">
			       <mx:Label text="Submissions :" styleName="infoBoxTxt" width="140"/>
			       <mx:Text id="subms" styleName="infoBoxTxt" />
			    </mx:HBox>
			</mx:Box>
			<mx:Spacer height="5"/>
		    <mx:HBox>
		       <mx:Label text="Start Date/Time :" styleName="infoBoxTxt" width="160"/>
		       <mx:Text id="start" styleName="infoBoxTxtNormal"/>
		    </mx:HBox>
		    <mx:HBox>
		       <mx:Label text="End Date/Time :" styleName="infoBoxTxt" width="160"/>
		       <mx:Text id="end" styleName="infoBoxTxtNormal"/>
		    </mx:HBox>
		    <mx:HBox>
		       <mx:Label text="Time Remaining :" styleName="infoBoxTxt" width="160"/>
		       <mx:Text id="timeRem" styleName="infoBoxTxtNormal"/>
		    </mx:HBox>
		    <mx:Spacer height="12"/>
		    <mx:Box styleName="sliderBox" horizontalAlign="center" verticalScrollPolicy="off" paddingTop="15" width="100%" height="48">
		    	<!--<mx:HSlider id="timeLine" 
				 width="80%" tickColor="black"
		         snapInterval="1" showDataTip="false"
		         allowTrackClick="true" />-->
		         <mx:HSlider id="timeLine" styleName="customHSlider" 
		         	thumbOffset="0" showTrackHighlight="true"  allowTrackClick="true" liveDragging="true"
		         	labelOffset="2" tickLength="0"  labelStyleName="labelStyle"
					width="393" showDataTip="false"/>
		    </mx:Box>

	
    
    <!-- Remaining time text effect -->
    <mx:Parallel id="textEffect" target="{timeRem}" repeatCount="0">
        <mx:Glow id="glowText" duration="2000" 
            alphaFrom="1.0" alphaTo="0.3" 
            blurXFrom="0.0" blurXTo="30.0" 
            blurYFrom="0.0" blurYTo="30.0" 
            color="0xFF0000"/>
    </mx:Parallel>
</tc:ContestMonitorWidgetCodeBehind>